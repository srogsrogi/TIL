# 웹서버와 MySQL DB 함께 배포하기

- 오늘은 학생이 두 명

- 한 분은 그동안 학습한 내용에 대한 사전지식이 부족해서 따로 2회에 걸쳐 사전학습(강의) 진행

  - 웹서버 작동구조 약 15분
  - CI/CD 과정, 환경변수 작동원리, git branch 개념, EC2 인스턴스 및 보안그룹에 대한 이해 약 35분

  

## 선수 지식

- 가상화 기술(VM, Container)의 개념
- AWS EC2, Docker 사용법 기초
- 웹 서비스 시스템 아키텍쳐에 대한 이해
- Git 기초 개념 : pull, push, pr, merge, branch
- Github Actions를 통한 CI/CD에 대한 이해



## 학습 목표

- RDB와 MySQL의 개념과 특성에 대해 설명할 수 있다.
- Docker compose를 통해 웹서버와 DB서버를 함께 실행하고, CI/CD 파이프라인을 수정하여 EC2에 자동 배포할 수 있다.



## 들어가기 전에..

- 이해되지 않는 부분이 있으면 말을 끊고 적극적으로 질문하세요!



- 우리가 지금까지 한 것

  - `index.html`에서 프론트엔드 구조를 만들었고
  - `server.py`에 FastAPI 서버를 작동시키는 코드를 작성했고
  - `Dockerfile`과 `requirements.txt`를 통해 Docker **Image**를 빌드 / 배포할 수 있게 되었고
  - 배포한 Image로 **AWS EC2** 서버 내에서 **Container**를 만들어 서버를 구동하였으며
  - `*.yml`을 작성하고 Github의 **Actions**와 **Secrets** 기능을 활용하여 **CI/CD** workflow를 생성하고 Image 빌드 ~ 서버 구동까지의 과정을 자동화하였습니다.

  

- 오늘 우리가 할 것

  - **RDB**와 MySQL에 대해 간단하게 설명하고(이론)
  - 잘~ 만들어놓은 서버 실행 workflow에 **MySQL DB서버 구동**을 추가해볼 겁니다(실습).
  - 웹서버와 DB서버는 서로 다른 역할을 수행하므로, 별개의 공간에서 실행되어야 합니다.
  - 우리는 **하나의 AWS EC2 인스턴스 공간 안에 2개의 컨테이너를 실행**시켜 독립된 환경에서 웹/DB 서버를 구동해보겠습니다.
  - 이를 위해 **Docker** 앱의 **compose** 기능을 사용합니다.

  

- 참고사항

  - 이번 실습은 우리가 앞으로 주로 진행할 소규모 프로젝트에 적합한 형태로 기획되었습니다.
    - 우리의 DB는 웹서버 외 외부 서버에서 활용될 가능성이 낮기 때문에
    - 운영 복잡도를 낮추고, 보안상 네트워크 공격면을 좁히기 위해 단일 서버 내 컨테이너 분리 방식을 선택했습니다.

  - 그러나 오늘 하는 방식은, 웹 서버에 DB를 붙일 수 있는 수많은 방법 중 하나에 불과합니다.

    - AWS RDS 서비스를 통해 EC2 인스턴스에 직접 DB를 붙일 수도 있고
    - EC2 인스턴스 자체를 분리하여 mysql 서버를 실행할 수도 있으며
    - 그 밖에도 수많은 방법론과 세부 설정에 따라, 같은 기능을 구현하기 위한 다른 환경이 구성될 수 있습니다.

    - 오늘 배운 방식 외에도 다양한 방법론과 그에 따른 장단점이 있다는 걸 인지하시고, 큰 그림을 놓치지 않으면서 학습해주세요!



## 이론

- RDB가 뭔지, MySQL이 뭔지 가볍게 설명
- 수업자료: `250909_my_sql.md`



## 실습

- `.env`는 일회용 실습 상황에서는 공개해도 상관 없는 변수들만 써놓고 git에 올려둠

  - 실제 개발/배포시에는 untrack
  - github secrets 변수로 넣어주기

  

- docker compose 설명

  - 여러 개의 컨테이너를 묶어 하나의 앱으로 배포할 수 있게 해주는 docker의 기능

  - `*.yml`을 통해 환경을 설정하고 동시에 컨테이너를 실행하는 명령

    - 서비스(=개별 컨테이너)간 네트워크 설정
    - 개별 서비스에 대한 환경 설정 등

    

- `docker-compose.yml` 들여다보기

  - PORT에 대한 이해
  - `.env 참조`

    - CD workflow에서 만들어지는 파일 참조
  - `depends_on` 필드

    - 타 서비스 실행 대기
  - `volumes` 필드

    - 컨테이너 외부에 있는 Host 시스템(EC2)에 데이터 저장
  - `networks` 필드

    - bridge : Host 서버 내 컨테이너끼리만 통신 허용
    - host : Host 서버 주소를 사용하여 외부 접속 허용, 개발 환경에서만 '제한적' 사용
    - 그 외에도 있는데.. 일단 패스

    

- cicd workflow 설명 / `ci-cd-add-mysql.yml` 들여다보기

  - 웹 서버 이미지는 우리 코드를 기반으로 만들고, DB 서버 이미지는 공식 이미지 사용
  - 전체 workflow 순서 및 의존성 훑기
  - `.env`가 생성되는 지점
  - healthcheck workflow

  

- `requirements.txt`와 `server.py` 확인

  - `mysql-connector` 추가와 healthcheck endpoint 작동 방식

  

- push 후 서버 작동 확인
  - IPv4 주소로 접속 테스트

  - Github Actions 로그 확인

    - 전체적인 로그 및 DB healthcheck 결과 확인

  - EC2 ssh 접속 후 container 목록 및 상태 확인

    

- EC2에서 container shell 접속을 통해 MySQL root계정 접근

  - `docker exec -it <container id> mysql -u root -p<password>`
  - 개발자용 admin 계정 / 웹서버에서 사용할 계정 생성 및 권한 부여

  

- DBeaver로 서버 직접 접속
  - CRUD 후 결과를 시각적으로 확인하기 위한 접속(학습용)
  - 실서비스시 EC2의 3306 PORT는 막아둘 것(웹서버를 통한 간접 접근만 허용)
  - admin 계정으로 접속하여 쿼리 실행 테스트



## Wrap-up Quiz

- 진행하고 있는 프로젝트(지하철 정보 제공 웹앱)에 MySQL DB를 연결하려는 이유가 무엇인가요?
- Docker에서 **run**을 여러 번 하는 대신 **compose**로 컨테이너를 실행하는 이유는 무엇인가요? 
- 운영 환경에서 DB PORT(3306)를 열어 놓지 않는 이유가 무엇인가요?
- `docker-compose.yml`에 **volumes** 필드가 없다면, DB 컨테이너가 재생성될 때 어떤 문제가 생길까요?



## 수업 마무리

- 원활한 수업 진행을 위해 어느 정도 검증된 구조를 만들어 와서 실습을 했지만..

  - 실제로 앱을 만들고 배포를 하는 과정에서는 수많은 오류(특히 보안 관련 이슈)를 마주할 가능성이 큽니다.
  - Django 등의 웹 프레임워크, 사용하는 언어, 라이브러리들이 늘어날수록 각각 요구하는 요소들이 뒤섞이면서 여러 문제가 발생합니다.
  - 이 때 GAI에 의존해서 국소적으로 문제를 해결하면 그 변경사항이 다른 상황에서 문제를 일으키고 코드가 꼬이게 됩니다.
  - AI 도움을 받아 코드를 작성하는 건 당연하지만, 그때그때 좀 어렵더라도 최대한 이해하면서 진행하시길 바랍니다.

  

- 오늘 다룬 것은 비어 있는 DB서버를 웹서버와 함께 배포하는 방법일 뿐이고, DB 설계나 운영에 대한 내용은 포함되어 있지 않습니다.

  - 다음 수업에서는 ERD 설계 방법을 학습할 것이고
  - SSAFY 정규 수업에서 Django ORM을 통한 DB CRUD를 배울 예정입니다.

  - 여기까지 하고 나면 실제로 프로젝트 내에서 DB를 활용한 서비스를 구현하실 수 있을 것입니다.

    

- 수업에서는 덜 다뤘지만, 웹 서버 및 DB 서버의 보안 설정들을 이해하고 잘 관리하셔야 합니다.

  - DB의 root 계정, admin 계정, 서비스용 계정들을 최소권한원칙에 맞게 잘 설정하고, 각 계정의 ID, PW, 권한 등을 문서로 작성하여 팀원 간 공유하시길 바랍니다.
  - 예제로 드린 CI-CD workflow에는 DB PORT를 3306:3306으로 개방해두었지만, 실서비스 배포 환경에서는 부적절한 방식입니다. DB는 웹 서버를 통해서만 간접 접근할 수 있도록 설정해두시는게 좋습니다.



## 학생 피드백

### 학생 1

- 수업의 좋았던 점

거시적인 시선을 짚어주시는게 가장 좋다고 생각합니다. 왜냐면 어차피 직접 코딩을 해야, 뼈로 겪어야, 피와 살이 된다라고 생각이 있는데, 그런 관점에서 최고의 강의인 것 같습니다.

비유적 발언으로 첨언하자면, 헬스도 백날 김계란 김종국 봐봤자, 내 실력이 늘지 않는다.  그렇지만, 운동 유튜버를 보는 이유는 그들이 가지고 있는 어떠한 인사이트를 공유받고, 나의 지금 좁은 시야에서 보지 못하는 그런 장기적인 맥락(NO GREEDY)에서의 경험을 바탕으로, 왜 이런 방식으로 접근해야 하는지 피와 살을 나눠주십니다. 그런데, 강형욱처럼, 오은영처럼, 정말 초보자가 막히지 않도록 차분한 템포로 실습을 직접 따라갈 수 있게 해주신 부분이 엄청나게 인상적이었습니다.

- 수업의 아쉬웠던 점

mobaxterm 까먹었어요 다시 복습해오겠습니다.

- 오늘 배운 내용의 활용법

지금 개발하는 마이웨이 서비스에 야무지게 써먹겠습니다.

- 내가 잘 이해한 부분

ci cd sql까지 통합된 CI.yml 코드를 조금 이해할 수 있었습니다. 그리고, 전체적으로는 그래도 조금 이해한 것 같은데, 세부적인 코드는 나중에 다시 봐야할 것 같습니다. sql 시작할 때 admin계정에 전체 권한을 부여하는 부분이요.

- 앞으로 더 배우고 싶은 내용

개인적으로는 지금은 MOBAXTERM밖에 잘 모르지만, 수업을 들으면서 다른 도구도 직접 탐구해보고 싶다는 동기부여가 생겼습니다. 또 SQL이 실제 기업에서 데이터 분석용으로만 쓰이는지, 아니면 서비스 개발 쪽에서도 활용되는지 궁금해졌습니다.



### 학생 2

여러가지 방대한 정보를 유기적으로, 함축적으로 딱 필요한 부분만 찝어준게 넘 좋았습니다 전체적인 흐름을 끌고 가주셔서 좋은 것 같아요 ㅎㅎ 안좋은 점은 ..딱히 업습니다 ^.^



## 소감

- 그동안 해왔던 수업들과는 다른 면이 많은 수업이었어서, 여러 방면에서 새로운 어려움도 느껴지고 배움도 있었다. 좀 구체적으로는..
  - 학생이 둘이고, 둘이 가지고 있는 배경지식이 차이가 너무 많이 나서 적절한 템포나 용어 선택 등 전반적인 수업 진행을 어떻게 해야 할지 고민이 됐다.
  - 한 명만 있을 때는 학생의 이해도를 그때그때 언어/비언어적으로 체크하고 그에 맞게 조절해나갈 수가 있었는데, 두 명 되자마자 그게 거의 안 됐다.
  - 준비된 내용 없이 되는 대로 몇 시간 떠드는 것도 어렵지 않고, 준비된 내용으로 30분 정도 수업하는 것도 이제 좀 익숙해졌지만 이번에는 많은 내용을 준비하고 1시간(사전학습 연강한 거 합치면 1시간 50분) 이상을 한 호흡으로 이끌어야 했어서 내가 수업 준비하는 것도 쉽지 않았고 학생들이 집중하면서 따라오기도 더 힘들어 보였다. 한 번에 전달해야 하는 양이 많을 때는, 수업 시간이 몇 분 더 늘어나더라도 내가 더 여유 있는 템포로 학생들 상황도 체크하고, 쉬는 시간도 가지면서 리프레시할 계획을 가지고 있어야 할 듯. 근데 이번엔 쓸 수 있는 시간이 워낙 한정적이어서 어쩔 수 없었던 부분도 있다 ^^..
  - 수업자료에 선수지식, 학습목표, wrap-up quiz 추가하면서 포맷 자체가 좀 더 확장됐는데, 꼭 필요한 부분이었고 수업 완성도가 한 층 올라간 것 같아서 좋다. 왜 여태 생각 못 했지?
  - 학습 내용이 많긴 해도  대부분 중요한 내용이어서 강약조절을 좀 덜 한 느낌이 있는데, 그 와중에도 우선순위를 잘 설정해서 더 중요한 것들이 먼저 전달되도록 노력해야겠다.
