# 웹서버와 MySQL DB 함께 배포하기

- 오늘은 학생이 두 명
- 한 분은 그동안 학습한 내용에 대한 사전지식이 부족해서 따로 웹서버 작동구조 15분 정도 설명함
- 추가로 설명해야 하는 내용
  - cicd 과정 이해
  - 환경변수 작동원리 이해
  - EC2 인스턴스 보안그룹(PORT)에 대한 이해

## 들어가기 전에..

- 우리가 지금까지 한 것

  - `index.html`에서 프론트엔드 구조를 만들었고
  - `server.py`에 FastAPI 서버를 작동시키는 코드를 작성했고
  - `Dockerfile`과 `requirements.txt`를 통해 Docker **Image**를 빌드 / 배포할 수 있게 되었고
  - 배포한 Image로 **AWS EC2** 서버 내에서 **Container**를 만들어 서버를 구동하였으며
  - `*.yml`파일을 작성하고 Github의 **Actions**와 **Secrets** 기능을 활용하여 **CI-CD** 워크플로우를 생성하고 Image 빌드 ~ 서버 구동까지의 과정을 자동화하였습니다.

- 오늘 우리가 할 것

  - 잘~ 만들어놓은 서버 실행 워크플로우에 DB서버 구동을 추가해볼 겁니다.
  - 웹서버와 DB서버는 서로 다른 역할을 수행하므로, 별개의 공간에서 실행되어야 합니다.
  - 우리는 **하나의 AWS EC2 인스턴스 공간 안에 2개의 컨테이너를 실행**시켜 독립된 환경에서 웹/DB 서버를 구동해보겠습니다.
  - 이를 위해 **Docker** 앱의 **compose** 기능을 사용합니다.

- 참고사항

  - 이번 실습은 우리가 앞으로 주로 진행할 소규모 프로젝트에 적합한 형태로 기획되었습니다.
    - 우리의 DB는 단일 웹서버 외 외부 서버에서 활용될 가능성이 낮기 때문에
    - 운영 복잡도를 낮추고, 보안상 네트워크 공격면을 좁히기 위해 단일 서버 내 컨테이너 분리 방식을 선택했습니다.

  - 그러나 오늘 하는 방식은, 웹 서버에 DB를 붙일 수 있는 수많은 방법 중 하나에 불과합니다.

    - AWS RDS 서비스를 통해 EC2 인스턴스에 직접 DB를 붙일 수도 있고
    - EC2 인스턴스 자체를 분리하여 mysql 서버를 실행할 수도 있으며
    - 그 밖에도 수많은 방법론과 세부 설정에 따라, 같은 기능을 구현하기 위한 다른 환경이 구성될 수 있습니다.

    - 오늘 배운 방식 외에도 다양한 방법론과 그에 따른 장단점이 있다는 걸 인지하시고, 큰 그림을 놓치지 않으면서 학습해주세요!



## 이론

- RDB가 뭔지, MySQL이 뭔지 가볍게 설명
- 수업자료: `250909_my_sql.md`



## 실습

- `.env`는 일회용 실습 상황에서는 공개해도 상관 없는 변수들만 써놓고 git에 올림
  - 실제 개발/배포시에는 untrack
  - github secrets 변수로 넣어주기
- compose 명령어 설명 / `docker-compose.yml`파일 들여다보기
  - port에 대한 이해
  - `.env 참조`
  - `depends_on` 필드
  - `volumes` 필드
- cicd 워크플로우 설명 / `ci-cd-add-mysql.yml`파일 들여다보기
  - `.env`가 생성되는 지점 확인

- `requirements.txt`와 `server.py` 확인
  - `mysql-connector` 추가와 healthcheck endpoint 작동 방식

- push 후 서버 작동 확인
  - IPv4 주소로 접속 테스트
- DBeaver로 서버 직접 접속
  - CRUD 후 결과를 시각적으로 확인하기 위한 접속(학습용)
  - 실서비스시 EC2의 3306 PORT는 막아둘 것(웹서버를 통한 간접 접근만 허용)
