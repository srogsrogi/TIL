# Reverse Proxy와 Nginx



## 선수 지식

- 웹 서버와 클라이언트의 동작 방식에 대한 이해

- VM 및 Container 개념 이해 및 관련 도구 사용법 이해

  - AWS EC2 보안 그룹 설정
  - MobaXterm을 통한 SSH 접속

  - Docker Image build|push|pull, Container run

- CLI에 대한 이해



## 학습 목표

- Proxy의 개념과 필요성을 설명할 수 있다.
- Nginx의 핵심적인 역할 세 가지를 설명할 수 있다.
- 서버에 Nginx를 설치하고 설정 파일을 작성하여 요청을 애플리케이션 서버로 전달할 수 있다.



## Warm-up

- 시스템 아키텍쳐를 설명할 때, Nginx는 웹 서버의 문지기 같은 녀석이라고 여러 번 언급했는데요.
- 요청을 서버로 직접 전달해도 잘 작동하는데도, 여러분의 프로젝트에서는 Nginx를 설치해서 사용하고 있습니다.

- Nginx의 필요성과 역할에 대해 알아봅시다.



## 이론

### 프록시(Proxy)

- 클라이언트와 서버 사이에서 요청을 대신 받아 처리해주는 서버
- proxy의 종류
  - Forward Proxy : 서버 내부 사용자가 외부에 요청할 때 대신 요청을 처리
  - Reverse Proxy : 외부 사용자가 서버에 요청을 보내면 대신 내부서버에 요청을 보내고 결과 반환
- 보안성, 성능(속도), 확장성 개선에 기여
  - 보안성
    - 내부 구조 은닉
    - 보안 설정 중앙화
    - 특정 IP 차단, SSL 암호화 관리 등
  - 성능
    - C언어 기반으로 작성되어 데이터 처리 속도가 빠름
    - static files의 처리 속도를 높이기 위한 최적화가 잘 돼있음
  - 확장성 : 서버의 종류 등에 상관 없이 교체/수정해도 잘 돌아간다!



### Nginx

- 고성능 **Reverse Proxy** 서버
- 운영 환경에서 애플리케이션 서버(uvicorn/gunicorn) 앞단에 위치하여 요청을 관리하는 문지기 역할



### Nginx의 주요 역할

- **SSL/TLS 처리**
  - HTTPS 적용 시 인증서 관리 및 암호화 처리 담당
  - 앱 서버는 복잡한 SSL 설정 없이 내부 통신에 집중 가능
- **load balancing**
  - 여러 백엔드 서버로 트래픽을 분산시켜 성능과 안정성 향상
- **빠른 static files 제공**
  - C언어 사용 + 이벤트 기반 처리 -> 작업 최적화
  - 캐싱/버퍼링 -> 네트워크 전송 최적화



### Nginx 설정 파일

- 기본적으로 두 개의 설정 파일이 있음
  - `/etc/nginx/nginx.conf` : 전역 설정
  -  `/etc/nginx/sites-available/default` : 기본 서버블록 설정

- nginx가 실행되는 공간 내에 요청을 받을 서버가 하나 뿐이라면, `default`를 편집해서 사용

- 여러 서버가 서비스되고 있다면 `default`를 비활성화하고 개별 파일을 통해 설정해줘야 함



## 실습

- Docker CLI 및 AWS EC2 복습을 겸하여 진행

- `nginx_practice_django_project` 디렉토리 하위에 만들어둔 django 프로젝트를 기반으로 진행

  - `base` 디렉토리는 앱 1개에서 `index.html` 렌더링하는 간단한 프로젝트로, 실습의 시작 지점

  - `solution` 디렉토리는 `base`에서 실습을 완료한 이후의 상태

- html 페이지 렌더링하는 간단한 Django 앱 이미지 빌드
  - ALLOWED_HOSTS 작성
  - requirements.txt 작성
  - Dockerfile 작성
  - .dockerignore 작성
  - Docker build 및 DockerHub 배포

- EC2 인스턴스 접속

  - 인스턴스 생성
  - 보안그룹 설정(SSH, HTTP, 8000)
  - SSH 접속
  - `apt update`

- 웹 앱 컨테이너 실행

  - docker.io 설치

  - DockerHub 로그인

  - Image pull

  - Container run

    `docker run -d -p 8000:8000`

  - IPv4 주소 접속 확인

- Nginx 설치 및 동작 확인

  - `apt install nginx`
  - `systemctl status nginx`
  - `curl http://localhost`
  - IPv4 주소 접속 확인(Nginx 기본 페이지 렌더링)

- 설정 파일 수정

  - `nano` 편집기를 통한 설정파일 수정

    `nano /etc/nginx/sites-available/default`
    
    ```nginx
    server {
        # 80번 포트에서 들어오는 요청을 받습니다.
        listen 80;
    
        # 이 서버가 응답할 도메인 이름이나 IP 주소를 지정합니다.
        # 지금은 EC2의 IPv4 주소를 적고, 도메인을 구매하면 도메인 이름으로 바꿉니다.
        server_name 15.164.97.227;
    
        # Django 애플리케이션으로 요청을 넘겨주는 부분입니다.
        location / {
            # 이 헤더들은 클라이언트의 원래 요청 정보를 그대로 Django에게 전달하는 중요한 역할을 합니다.
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
    
            # 요청을 넘겨줄 주소. Django 컨테이너가 8000번 포트에서 실행 중이므로 아래와 같이 설정합니다.
            proxy_pass http://127.0.0.1:8000;
        }
    }
    ```

- 문법 검사 및 재시작

  - `nginx -t`
  - `systemctl reload nginx`

  - http 접속 확인(웹 앱 정상 실행)

- 접속 로그 확인

  - Nginx 로그

    ```cmd
    sudo tail -f /var/log/nginx/access.log
    sudo tail -f /var/log/nginx/error.log
    ```

  - Docker 로그

    `docker logs <container_id>`




## Wrap-up Quiz

- Proxy, 특히 Reverse Proxy의 개념을 설명해봅시다.
- Nginx의 핵심 기능 세 가지는 무엇인가요?
- 하고 계신 프로젝트의 시스템 아키텍쳐를 직접 그리고, 사용자의 요청에 따른 데이터의 흐름을 설명해봅시다.



## 강의 마무리

- 실습이 하고 계신 프로젝트의 구조와는 약간 다르게 진행되었습니다.
  - Nginx를 별도의 컨테이너에서 실행하지 않고 호스트 머신에 직접 설치했습니다.
  - 새로 배우는 내용이 많아 차시별 학습량을 조정하기 위함입니다.
  - 이후 차시에서 `docker compose` 기능과 함께 다시 다룰 예정입니다.

- 수업에서 실습 비중이 높아질수록, 금방 휘발되는 내용이 더 많아집니다.
  - 복습하며 내 손으로 다시 코드를 쳐보지 않으면 실습 내용 뿐만 아니라 개념도 같이 흩어집니다.
  - 토이 프로젝트나 실습용 코드를 만들어 실제 배포 경험을 가져보시기를 권합니다.

- 다음 시간에는 도메인에 `wisheasy.site`같은 이름을 붙여 주는 DNS와 https 접속을 가능하게 해주는 SSL 인증서에 대해 배워보겠습니다. 여기까지 배우면 웹앱 배포의 한 사이클이 마무리됩니다.



## 수강생 피드백

- 수강생 1

  프록시나 앱 서버 같은 개념이 잘 안 잡혀 있었는데, 이번 수업을 통해 그 차이를 명확하게 이해할 수 있었습니다. 특히 Django의 runserver와 실제 배포 서버의 차이를 배웠는데 실제 배포 서버의 존재도 처음 들었지만 잘 이해할 수 있었습니다. 또한 혼자 실습하는 게 조금 부담스러웠는데, 수업 중에 실습을 한 번 더 직접 따라 해보는 시간 덕분에 개념이 훨씬 잘 잡혔습니다.

- 수강생 2

  한 번 실행했을 때는 좀 어려웠지만 두 번째로 mobaXterm을 사용해보니 그 전보다 부담이 덜 했던 것 같습니다. 또 프록시의 개념이나, 앱 서버, 특히 장고 runserver와 배포 서버의 차이점 같은 것들이 모호했는데 어제 수업을 통해 차이점을 확실히 이해할 수 있었습니다. 토이 프로젝트로 된다면 직접 EC2 인스턴스를 만들고 nginx를 사용해보는 경험을 하고 싶다는 생각이 들었습니다. 



## 소감

- 오프라인 강의로 돌아오니까 속도도 좀 더 붙고, 강의력도 살아나는 것 같다.
- 두 명까지 커버하는 것도 익숙해졌다. 처음 할 때는 엄청 어려웠던 것 같은데, 지금은 딱히 그렇지 않다.
- 두 분 다 궁금한 거 바로바로 질문해주시는 편이라 나도 수업 나가기가 더 편안하고 좋다.
- 내가 지금까지 총 5시간 반 정도 강의한 것 같은데 벌써 인스턴스 만들고 mobaxterm 접속하고 하는 작업들이 익숙해져가고 계신 것 같아서 보람차다. docker 쪽은 명령어도 많고 compose도 배워야 하니 좀더 많은 연습이 필요할 듯