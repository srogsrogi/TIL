# 트러블 슈팅



## 개요

- PM이 작업하고 있는 CI-CD 워크플로우로 3-containers 동시 배포하기 어제부터 잘 안 되고 있어서 도와줌
- 되도록 해결책을 제시하기보다는 방향성만 잡아주려고 노력하긴 했는데..
  - 아직은 어느 정도 구체적인 방향성을 정해줘야 따라오실 수 있을 것 같아서 원래 계획보다는 좀 더 구체적인 방안들도 알려드렸음
  - 그래도 항상 물고기보다는 물고기 잡는 법을 알려드리려고 노력하고 있음



## 문제 상황

- 일단 배포 시도한 웹 서버로 접속이 안 되고
- ssh 접속 후 linux 명령어도 다 반응이 느림



## 해결 과정

- workflow의 핵심인 github actions의 로그부터 확인
  - 이미지 build / push 까지는 잘 됐는데 EC2 인스턴스에서 pull / run은 실패
  - 이미지명 및 태그 확인하고 일관성 있게 수정함

- ssh접속하여 nginx 돌고 있는 컨테이너 로그 확인
  - 접속 요청 도착도 안 했음
  - HOST 엔진(EC2) PORT 매핑 확인해서, HOST 공간에 예전에 설치해둔 nginx 앱이 80번 포트를 점유하고 있어서 컨테이너 안에 있는 nginx가 PORT를 받지 못한 것을 확인
  - HOST에 깔려 있는 nginx는 삭제
- 컨테이너도 자꾸 터지는 것 같고, 명령어 반응도 느린 것으로 봐서 하드웨어적 이슈가 있을 것이라고 추측
  - AWS free-tier로 t3.micro 쓰고 있어서 EBS Volume이나 RAM 모자랄 것은 예상하고 있었고, 이전에 비슷한 경험을 해봐서 바로 시스템 상태 보고 RAM 점유율 100% 찍힌 거 확인
  - 메모리 스왑 설정해서 강제로 RAM 2GB 추가 확보하여 해결
- 그 후 nginx 컨테이너 재시작하여 다시 PORT 매핑하도록 시도
  - -f 옵션 줘서 삭제하려고 해도 `exit event`를 받지 못했다면서 컨테이너가 안 꺼짐
  - `pkill`, `systemctl restart docker/containerd` 까지 해도 전혀 말을 안 들음
  - 결국 EC2 OS reboot하니까 지워짐



##### 이후 전체 CI/CD 워크플로우 가동, 도메인으로 정상 접속 확인



## 디버깅 원칙

- 나야 비슷한 걸 몇 번 해봤으니까 슬슬 구조가 머리에 들어오긴 하는데..
- 세부적인 과정은 여러 번 해보지 않으면 다 이해하거나 기억하지 못할 수밖에 없어서 해결 과정 자체보다는 접근 방식을 체화시키려고 노력했음
- 복잡한 서비스를 디버깅하는 과정에서 일반적으로 따라야 할 원칙을 두 가지로 나누어 정리함



### 원칙 1 : 요청(데이터)의 흐름을 따라가며 로그를 확인한다.

- 코드의 실행 순서나 데이터의 흐름에 따라 어느 서비스의 로그를 확인할 것인지 판단하고 살펴 보는 과정을 반복해야 함

#### Case-Study : 웹 서버 접속이 안 될 때

- push event 발생 시 가장 먼저 실행되는 CI-CD workflow의 주체인 Github Actions를 먼저 확인

- Actions가 docker pull / compose 단계에서의 오류를 가리키고 있으므로, 그게 실행되는 EC2 인스턴스 환경의 로그와 docker의 로그를 확인
- 만약 docker에서 별 문제가 없었다면 url로 요청을 넣었을 때 제일 먼저 그 요청이 도달하는 nginx 컨테이너의 로그를 확인
- nginx에서도 문제가 없었다면 nginx에서 django 웹서버로 요청을 잘 전달했는지 확인하기 위해 django 컨테이너의 로그를 확인



### 원칙 2 : 변경 사항(리스크)이 적은 방법부터 순차적으로 시도한다.

- Soft한 방법부터 시도하고 점차 Hard한 방법으로 넘어가는 게 좋음
- 순서만 지키는 게 아니라, 더 Hard한 방법을 선택했을 때의 리스크가 무엇인지 알고 나서 다음 시도를 이어나갈 것
- 물론 개별 방법이 전체 시스템에 미치는 영향을 대체로 파악하고 있다면 처음부터 더 센 방법을 시도해볼 수도 있겠지만, 실제로 서비스를 운영하고 있는 경우 가용성 유지, 데이터 보존 등이 훨씬 더 중요해지므로 보수적으로 접근할 필요가 있음

#### Case-Study : 좀비가 된 컨테이너를 삭제할 때

- 먼저 container stop 후 rm 시도
- 안 되니까 rm --force 옵션 시도
- 안 되니까 프로세스 찾아서 pkill 시도
- 안 되니까 systemctl restart 시도
- 안 되니까 os reboot 시도
- 그것도 만약에 안 됐으면 인스턴스 아예 종료하고 재생성을 한다든지 더 hard한 시도가 이뤄졌을 것



##### 서비스를 이루는 구성 요소가 많아질수록 데이터가 빈번하게 이동하고 흐름을 놓치기 쉽습니다.

##### 내가 데이터의 흐름을 이해하고 설계를 해야 디버깅도 할 수 있습니다.

##### 전체 구조를 온전히 이해하고 설계해야 개발을 이어나갈 수 있음을 항~~~상 생각하시고, 뼈대가 되는 코드 작성을 포함해서 초기 설계에 더 많은 공을 들이시면 나중에 고생을 덜 합니다.

##### 매일 시스템 아키텍쳐 그림 그려드리는 이유도 여기에 있습니다. 서비스를 개발할 때는 더 세세한 부분까지도 계속 상상하고 그려 보시길 바랍니다.

##### ※ GPT 쳐다보느라 내가 쓴 코드와 오류 메시지를 떠나지 말라는 조언도 이전에 공유해드린 문서들을 포함해서 여러 차례 반복하고 있습니다. 제 요구사항이 많고 처음부터 잘 안 되는 건 너무너무너무너무 당연하니까, 앞으로도 계속 피드백 듣고 스스로 돌아보시면서 함께, 조금씩 성장합시다!