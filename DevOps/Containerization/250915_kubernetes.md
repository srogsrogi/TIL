# Kubernetes(k8s)

- 컨테이너화된 앱의 자동 배포, 오토스케일링, 기타 관리 기능을 제공하는 오픈소스 플랫폼

- Google이 개발한 컨테이너 오케스트레이션의 표준



## 주요 개념

- Cluster
  - 전체 실행 환경
  - 여러 개의 마스터 노드(Control Plane Node) 및 워커 노드로 구성

- Node
  - 컨테이너를 실행하는 물리/가상 머신

- Pod
  - 하나 이상의 컨테이너를 포함하는 가장 기본적인 배포 단위
  - 같은 pod 내의 컨테이너들은 리소스를 공유함

- Deployment
  - pod의 선언적 업데이트를 관리
  - 롤링 업데이트, 롤백 등의 기능 제공

- Service

  - pod 집합에 대한 단일 접점(DNS, 이름표)을 제공
    - pod은 장애, 스케일링, 업데이트 등 이벤트가 있을 때마다 사라졌다가 새로 생성되는 가벼운 실행 단위
    - pod의 IP 주소는 자주 바뀌기 때문에, kubernetes에서는 주소 대신 고정 진입점 `service`를 사용
  - 로드 밸런싱
    - 각 node에 붙어 있는 kube-proxy가 L4 분산(IP/PORT 기반 트래픽 분산) 로드 밸런싱 규칙 설정
  - 서비스 디스커버리 기능
    - pod이 계속 죽었다 살아나도 `service`와 `DNS`의 조합으로 IP의 이름을 동적으로 찾아줌

- ConfigMap / Secret

  - 앱 구성 정보 및 민감 정보 관리
  - key-value 구조로 저장됨
  - Secret의 경우 자동으로 암호화를 지원하지는 않고 평문으로 저장됨
    - 별개의 etcd 암호화 설정이 필요

- Label

  - object를 그룹화하고 선택하기 위해 붙여 놓는 이름표
  - key-value 쌍으로 저장됨

- Annotation

  - **개발자가 보기 위한** 주석 같은 역할
  - object에 대한 정보(메모, 기능 설명, 관련 기능 링크 등)를 자유롭게 적어놓을 수 있는 공간
  - Label과 마찬가지로 key-value 쌍으로 저장됨

- Namespace

  - cluster 내의 리소스를 논리적으로 분리

    - 이름 충돌 방지

    - 권한 관리
    - 네임스페이스별 리소스 할당 및 제한
    - 필요시 secret 등 일부 리소스 격리
    - 개인 / 소규모 팀에서는 그렇게 중요하진 않아서 일단 pass

  



## 주요 기능

- Autoscaling
  - HPA(수평적 pod 자동 스케일러)
    - 리소스 사용량이나 개발자가 지정한 metric에 따라 pod 수를 조절하는 기능
    - 별도의 metric 서버에서 수집한 리소스 사용량과 설정된 임계치를 비교하여 replica 수 자동 조정
  - Cluster Autoscaler
    - Node(VM 인스턴스)의 수를 조절하는 기능
    - 일반적으로 HPA와 함께 사용
    - pod이 더 이상 늘어날 자리가 없으면, cloud에 node를 추가로 생성하고
    - pod이 하나도 없이 놀고 있는 node가 있으면 해당 node를 종료하는 방식
      - kubernetes의 독립적인 기능은 아니고, AWS 등 cloud vendor의 autoscaling group API와 통합됨

- Self-Healing
  - 선언형 시스템으로서, 원하는 상태와 현재 상태를 주기적으로 비교하면서, 달라지면 자동으로 원하는 상태로 맞춰 주는 기능
  - 죽어서 응답하지 않는 pod이 있으면 자동으로 새 pod을 띄움
  - 특정 node 전체가 죽으면 다른 node에 새로운 pod을 그만큼 만듦
  - `livenessProbe`와 `readinessProbe` healthcheck를 기반으로 pod 교체 수행

- 무중단 Rolling 업데이트 및 Rollback

- Storage Orchestration
  - NFS, Cloud storage 등 여러 형태의 storage system 지원
  - PV(Persistent Volume)과 PVC(Persistent Volume Claim)를 통해 storage 관리 추상화

##### 		PV : 외부 storage에 대한 추상화된 연결 정보 객체로서, cluster 차원에 존재함. 보존이 필요한 데이터들이 		pod이 죽을 때도 사라지지 않도록 하는 역할을 수행함

##### 		PVC : pod 개발자가 요청하는 PV에 대한 요구사항. "몇 GB의 storage가 필요하다."와 같이 추상화되어 있음

##### 		즉 PVC를 통해 요청된 storage는 클러스터 관리자의 PV 설정에 의해 유연하게 공급되며, PVC 작성자인 pod 개발자는 storage의 종류나 사용 기술을 몰라도 일관적으로 추상화된 요청이 가능



## 사용 전략

- 마이크로서비스 아키텍쳐
  - 운영 복잡성 해소 및 확장성 확보 등에 기여
- 블루-그린 배포 및 카나리 배포
  - 배포시 리스크 최소화
- 멀티 클라우드 및 하이브리드 클라우드
  - 다양한 환경에서 일관된 방식을 사용하여 통합적으로 앱 운영 가능

- CI / CD 통합
  - 일관성 있는 GitOps 방식으로 리소스 관리



## 질문/답변

- Q1. `Service`가 DNS와 로드밸런싱을 함께 제공하는게 nginx의 그것과 비슷하게 느껴지는데, 실제로 내부 기능 구성이 비슷한가?

  - 기능적으로는 꽤 비슷해 보일 수 있는데, 내부 동작은 꽤 다른 부분이 있음

  - nginx는 L7 레벨(앱 단까지 이해)의 로드 밸런싱

    - 요청의 URL(endpoint), cookie 등까지 보고 라우팅을 결정하고 더 많은 부가 기능도 제공함

  - kubernetes의 service는 L4 레벨(IP/PORT)의 로드 밸런싱

    - L7 레벨 로드 밸런싱보다는 훨씬 단순한 형태
    - L7 레벨의 세밀한 라우팅 설정이 필요한 경우 Ingress 컨트롤러나 Gateway API 사용 필요

    

- Q2. 팀 규모가 작으면 Cluster 관리자와 Pod 개발자가 딱히 구분되지 않을 것 같은데, 그럴 땐 오히려 세분화된 권한 설정이 불편할 것 같음. 그런 경우에 사용할 수 있는 대안은 없나?

  - pod에서 직접 storage volume을 지정하는 방식도 있긴 한데..
  - 데이터 영속성을 갖기 위해 추가 설정이 필요하고, 이식성과 유연성도 부족해서 프로젝트 규모가 커질 경우 유지보수에 매우 불리함
  - 실제 운영되고, 확장될 가능성이 있는 서비스라면 당장 조금 불편해보이더라도 PV / PVC를 분리하여 운영하는 것이 권장됨



- Q3-1. Label과 Annotation은 pod에만 붙을 수 있는 거야? 모든 object에 붙을 수 있는 거야?

  - 모든 object에 붙을 수 있음
  - k8s에서 선언되는 모든 object는 metadata 필드를 가지고 있음
  - label과 annotation은 모두 metadata 필드 하위에서 선언될 수 있음

  

- Q3-2. 그럼 개발자가 실수로 pod에 대한 label을 다른 종류의 object에 넣어버리면 그 label에 대해 pod 명령어를 쓰면 오류가 발생하는 건가?

  - ㄴㄴ. k8s 명령어들은 대부분 어떤 종류의 오브젝트에 적용할 것인지를 포함하고 있고, 거기에 해당되지 않는 오브젝트라면 같은 label을 가지고 있더라도 선택되지 않음
  - 가령 `get pods` 명령어라면, 종류가 pod인 object를 선택한 후에 label 조건을 만족하는지 확인하기 때문에 pod이 아닌 오브젝트에는 label과 상관 없이 명령어가 도달하지 않음
  - 유연성은 좀 떨어지지만, 안정성을 확보한 설계 방식



## 소감

- 겨우 한 발짝 깊이 들어온 것 같은데 개념부터 새로운 것들이 많아서 좀 빡빡함
- GPT한테 Q1 물어봤을 때 태어나서 처음 보는 단어 한 10개 튀어나와서 좀 당황했다. 지금 단계에서 너무 깊게 파고들면 전체적인 흐름을 놓칠 것 같아 일단 가볍게만 정리해둠. 한바퀴 돌고 나면 내부동작도 다시 들여다보면서 한 단계 더 깊이 공부하게 될 것

- 기초적인 배포 자동화 정도만 공부했을 때는 '이런 거 뭐 누구나 하루이틀 배우면 하는 거지.'라는 생각이 강했는데, 지금부터 한두 달 열심히 쌓아나가면 어지간한 신입들은 갖기 쉽지 않은 devops에 대한 메타적 이해를 얻을 수 있을 것 같아서 설렌다.