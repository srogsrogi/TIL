# Toss의 k8s 자원 최적화

- https://www.youtube.com/watch?v=WdikCm_CYms

- 공부가 안 되는 날이어서 기술 블로그나 뒤적거리다가 재밌어보여서 정리함

- 아직 기초적인 사용법도 못 익힌 상태라 당장 활용은 못 하지만, 의외로 그럭저럭 알아들을만은 했다.

- 아저씨가 5분 떠들면 내가 정리하는데는 10분이 더 걸려서.. 영상 내용을 전부 정리한 건 아니고, 이해한 부분만 잘 정리해둠

  

## CPU 최적화

### CPU throttling 방지

#### 문제

- CPU 사용량 추이가 설정해둔 limits보다 낮아도 throttling이 발생할 수 있음
  - CFS(각 pod에 CPU를 할당하는 스케쥴러) quota가 100ms 단위로 CPU 사용량을 체크하고 limits보다 크면 throttling을 거는 방식으로 동작함
  - 전체적인 CPU 사용량이 limits보다 적어도, 단위 시간 내 사용량이 급증하는 경우 불필요한 throttling을 걸 위험이 있음

#### 해결 방안

- `cpu-cfs-quota-period`를 낮추거나(토스의 경우 10ms)
- 특정 컨테이너에 대해서는 limits를 아예 없애서 quota를 비활성화하면 이러한 문제를 완화할 수 있음

#### trade-off

- period를 낮추면 그만큼 사용량을 확인하는 작업이 늘어나니까 오버헤드가 발생할 수 있고

- quota를 비활성화하면 말 그대로 지 맘대로 CPU를 점유해버리기 때문에 모니터링에 신경을 더 써야 함

  

### CPU 자원 할당량 최적화(Right sizing)

#### 전제

- 토스 서버는 IDC 환경을 사용
- 대고객 서비스의 고가용성 유지를 위해 Active-Active 방식을 사용하고 있음
  - 데이터센터가 2개가 있고, 한 곳이 문제가 생겨도 다른 한 곳에서 평소에 받던 트래픽의 2배를 처리할 수 있어야 함
  - Requests는 하루 최대 사용량의 2배, limits는 아예 없게 설정
- 대고객 서비스가 아닌 나머지 서비스에 대해서는 Requests는 하루 최대 사용량과 비슷하게 설정하고, limits는 그것보다 조금 높은 수준으로만 유지

#### 문제

- IDC 환경이라 단시간 내 물리 서버 증설은 불가능
- auto-scaling을 허용하면, 특정 서비스가 pod을 증설하면서 전체 서버의 자원을 과점유하여 문제가 생길 수 있음

#### 해결 방안

- Projection 방식 사용
  - 최대 부하를 사전에 추산하고 그에 맞추어 할당량을 조정
  
- Grafana, Prometheus, Thanos 등 tool을 통해 Alert를 활용
  - 할당량이 너무 낮아서 여유가 부족한 경우
  - 할당량이 너무 높아서 자원이 낭비되는 경우
  - Alert의 기준 Metric은 `Requests 대비 사용량`으로 함
  
- Alert의 Noise(부정확/중요하지 않은 Alert) 제거 필요
  - Warm-up하는 동안 발생하는 초기 부하 무시
  
  - 최대 사용량 체크 주기를 1주로 하여 시간대에 따라 사용량이 줄어들어 발생하는 noise 무시
  
    

## Node 리소스 최적화

### resource fragmentation 방지

#### 문제

- Node가 되는 VM의 사양이 서비스와 맞지 않는 경우 비효율이 발생할 수 있음
- 예를 들어, CPU의 worker는 이미 다 쓰고 있어서 새로운 pod을 띄울 수 없는데, RAM은 남아 도는 경우
  - 반대의 경우나, 다른 리소스들과의 관계에서도 발생 가능한 문제

#### 해결 방안

- 다양한 리소스의 사용량을 파악하고 그에 맞는 사양의 node를 띄워야 함

  

### node 스펙 최적화

#### 문제

- Node마다 9개의 daemonset(서비스 유지를 위해 필요한 최소한의 세팅)이 뜨고 있음
- node마다 daemonset의 점유량이 너무 커서 전체적인 리소스 효율성을 저해

#### 해결 방안

- 각 node를 4배 scale-up

- 40% 가량의 리소스 효율화 성공

  

## 소감

- 쓴 내용 외에도 불필요한 연산을 없앤다든지, 모니터링 아키텍쳐 개선하는 부분도 있었는데..
- 아직 해당 tool들을 다뤄본 게 아니라서 지금 공부하기엔 너무 깊은 내용이라 스킵함
- 공부 잘 못 한 날 이거라도 해서 좀 위안이 된다.