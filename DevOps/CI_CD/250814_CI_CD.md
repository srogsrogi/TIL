# CI / CD

- 사용하는 언어, 프레임워크 등에 따라 CI/CD 환경 구축을 위한 다양한 tool들이 있는데..
- 일단 Nginx와 Docker container 사용하는 django 웹서버와 Github Actions를 활용하여 테스트할 것

- https://docs.github.com/ko/actions/tutorials/build-and-test-code/python



## 개념

- Continuous Integration
  - 코드를 통합하고 빌드/테스트하는 과정 자동화
- Continuous Delivery / Deployment
  - 배포 준비 단계까지 자동화 or 배포 실행까지 자동화

- CI/CD를 묶어서 얘기하는 경우가 많지만, 개념 구분이 필요
  - CI는 개발 단계에서 사용하는 각 브랜치에도 필요
  - CD는 릴리즈(또는 테스트) 서버가 연결되어 있는 브랜치에만 필요함



## 목적

- 배포 안정성 향상
- 배포 속도 증가
- 개발 - 운영 협업 효율 증가



## CI/CD Pipeline

1. ##### Trigger 작동

   - commit / push

   - 일반적으로 main branch에 push(merge)가 이뤄지면 pipeline이 작동

   - 따라서 main branch에는 push 불가 등 보호 조건을 걸어둠

2. ##### CI(Build & Test)

   - CI server에서 진행

   - github actions의 경우 자동으로 VM을 제공하여 CI server의 역할까지 해줌

3. ##### Artifact 생성

   - docker image

   - `/dist` 폴더(정적 파일 묶음)

   - 압축 패키지(`.zip`, `.tar.gz` 등)

4. ##### CD

   - 배포 준비 또는 배포 실행



### CI

- Linting

  - Python 기준
    - **Linter**(python 문법 검사 tool)로는 `flake8`과 `ruff` 등이 대표적
    - `flake8`은 전통적으로 많이 써온 안정적인 모듈, `ruff`는 매우 빠르면서 기능도 많고 안정적이라 새로운 표준이 되고 있음


  - 당연히 다른 언어나 프레임워크를 위한 Linting tool들도 있으니, 쓰는 것들을 추가해주면 됨

  - 하나의 단계에 묶지 말고 개별/순차실행되도록 해야 뭐가 문제였는지 로그를 명확하게 볼 수 있음


- Build test
  - Github 서버 내에서 이미지 빌드 테스트
  - 컨테이너 실행, healthcheck, 주요 기능 수행 등까지 테스트 가능

### CD

- 워크플로우야 다양하게 만들 수 있겠지만..
- 기본적으로는 Docker image 빌드 -> DockerHub 푸시 -> EC2 인스턴스에서 pull -> 컨테이너 실행 순이 될 것

- 무중단 배포
  - 로드 밸런서가 실행해둔 여러 개의 인스턴스 중에서 일부만 새 이미지로 빌드해서 배포하고(트래픽은 나머지에 몰빵)

  - 잘 되면 나머지 서버도 순차적으로 배포

- healthcheck 실패시 rollback
  - 2개의 태그(원래 되던거, 새 버전)로 배포하고 새 버전 실행해서 안 되면 되던 거 실행

- 무중단 배포나 rollback 같은 심화 과정은 이후에 추가 학습/실습 필요

##### 실습내용은 `Lesson/publishing_web_app/250903_ci_cd.md` 참고



## 소감

- 이전에 프로젝트 몇 번 할 때는 팀원들한테 맡겨 놓고 그런갑다 했는데
- 막상 해보니까 별 오류 없이 쓱쓱 잘 돼서 재밌음
- 여러 번 프로젝트/수업 하면서 개발 - 배포의 전 과정이 머릿속에 정리돼있으니까 각 과정에서 어떤 secret key들이 필요할지도 알아서 떠오르고.. 많이 성장한게 느껴진다.
- `250909`에 수업 준비하다가 내용 좀 추가했는데, 여러 번 볼수록 생각의 범위가 넓어지는 걸 느낀다.
